<!--
 I declare that this code was written by me. 
 I will not copy or allow others to copy my code. 
 I understand that copying code is considered as plagiarism.
 
 Student Name: Ray
 Student ID: 24026513
 Class: C372-003-E63C
 Date created: 20/1/2026
  -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="/theme.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <title>My Trades</title>
  <style>
    body {
      background: #0b0c0f;
      color: #e9ecef;
      font-family: 'Montserrat', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }
    .page-shell { padding-top: 2rem; padding-bottom: 2rem; }
    .glass-card {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 1rem;
      backdrop-filter: blur(12px);
      box-shadow: 0 18px 40px rgba(0,0,0,0.5);
    }
    .custom-navbar {
      background-color: transparent !important;
      padding-top: 1.05rem;
      padding-bottom: 1.05rem;
      min-height: 80px;
      z-index: 1030;
      box-shadow: none;
    }
    .chat-link {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 38px;
      height: 38px;
      border-radius: 999px;
      border: 1px solid rgba(88,166,255,0.45);
      background: rgba(88,166,255,0.12);
      color: #d5f3ff;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .chat-link:hover {
      color: #ffffff;
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(15,176,255,0.3);
    }
    .chat-link svg { width: 18px; height: 18px; }
    .brand-logo {
      font-family: 'Montserrat', system-ui, sans-serif;
      display: inline-flex;
      flex-direction: column;
      text-align: center;
      text-decoration: none;
      line-height: 1.05;
      padding-left: 0.1rem;
    }
    .brand-main {
      font-size: 1.45rem;
      font-weight: 700;
      letter-spacing: 0.33em;
      text-transform: uppercase;
      color: #ffffff;
    }
    .brand-sub {
      font-size: 0.68rem;
      font-weight: 500;
      letter-spacing: 0.28em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.75);
      margin-top: 0.15rem;
    }
    .notification-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 1rem;
    }
    .notification-card {
      background: linear-gradient(140deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.02) 100%);
      border: 1px solid rgba(88,166,255,0.25);
      border-radius: 16px;
      padding: 1rem 1.2rem;
      box-shadow: 0 12px 30px rgba(0,0,0,0.35);
    }
    .notification-item {
      padding: 0.65rem 0.8rem;
      border-radius: 12px;
      background: rgba(6,12,22,0.7);
      border: 1px solid rgba(255,255,255,0.08);
    }
    .notification-item + .notification-item { margin-top: 0.6rem; }
    .notification-meta { font-size: 0.75rem; color: rgba(234,242,255,0.7); }

    .trade-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1rem;
    }
    .trade-card {
      background: rgba(6,12,22,0.7);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      padding: 1rem;
      box-shadow: 0 12px 26px rgba(0,0,0,0.35);
    }
    .pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-height: 28px;
      border-radius: 999px;
      padding: 0.2rem 0.75rem;
      font-weight: 700;
      letter-spacing: 0.02em;
      font-size: 0.72rem;
      text-transform: uppercase;
      white-space: nowrap;
    }
    .pill-open { background: rgba(59,130,246,0.18); color: #bfdbfe; border: 1px solid rgba(59,130,246,0.4); }
    .pill-pending_initiator { background: rgba(234,179,8,0.16); color: #fde68a; border: 1px solid rgba(234,179,8,0.4); }
    .pill-accepted { background: rgba(16,185,129,0.18); color: #a7f3d0; border: 1px solid rgba(16,185,129,0.45); }
    .pill-declined { background: rgba(239,68,68,0.16); color: #fecdd3; border: 1px solid rgba(239,68,68,0.45); }
    .pill-cancelled { background: rgba(107,114,128,0.16); color: #e5e7eb; border: 1px solid rgba(107,114,128,0.45); }

    .btn-ghost {
      border-radius: 999px;
      border: 1px solid rgba(74,212,255,0.5);
      color: #d5f3ff;
      background: rgba(74,212,255,0.08);
    }
    .btn-ghost:hover { color: #fff; border-color: rgba(74,212,255,0.7); background: rgba(74,212,255,0.14); }
    .form-select, .form-control { background: rgba(255,255,255,0.04); color: #e9ecef; border: 1px solid rgba(255,255,255,0.12); }
    .form-select:focus, .form-control:focus { box-shadow: 0 0 0 0.15rem rgba(74,212,255,0.25); border-color: rgba(74,212,255,0.5); }
    .form-select option { background: #0b0c0f; color: #e9ecef; }

    .chat-panel {
      margin-top: 0.8rem;
      padding: 0.75rem;
      border-radius: 12px;
      background: rgba(255,255,255,0.03);
      border: 1px dashed rgba(255,255,255,0.12);
    }
    .chat-messages {
      max-height: 180px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
      padding-right: 0.3rem;
    }
    .chat-message { display: flex; flex-direction: column; gap: 0.2rem; }
    .chat-bubble {
      padding: 0.45rem 0.7rem;
      border-radius: 12px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
    }
    .chat-out .chat-bubble { background: rgba(88,166,255,0.2); border-color: rgba(88,166,255,0.4); }
    .chat-meta { font-size: 0.7rem; color: rgba(234,242,255,0.7); }
    .chat-form {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 0.5rem;
      margin-top: 0.6rem;
    }
    .chat-form input {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.12);
      color: #fff;
      border-radius: 999px;
      padding: 0.4rem 0.9rem;
    }
    .chat-form button {
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.18);
      background: linear-gradient(90deg, #0fb0ff 0%, #4ad4ff 100%);
      color: #04101f;
      font-weight: 700;
      padding: 0.35rem 0.9rem;
    }
    .proposal-panel {
      margin-top: 0.8rem;
      padding-top: 0.6rem;
      border-top: 1px solid rgba(255,255,255,0.08);
    }
    .proposal-card {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 0.4rem;
      padding: 0.45rem 0.6rem;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.04);
    }
    .proposal-card + .proposal-card { margin-top: 0.5rem; }
    .proposal-actions { display: flex; gap: 0.4rem; }
    .proposal-actions button {
      border-radius: 999px;
      padding: 0.2rem 0.7rem;
      font-size: 0.75rem;
    }
    .trade-shell {
      background: rgba(5, 10, 19, 0.64);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 1rem;
      padding: 1rem;
    }
    .trade-shell-head {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 0.8rem;
      margin-bottom: 0.9rem;
    }
    .trade-tabs {
      display: inline-flex;
      gap: 0.4rem;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.12);
      padding: 0.25rem;
      border-radius: 999px;
      margin-bottom: 0.9rem;
    }
    .trade-tab-btn {
      border: 0;
      border-radius: 999px;
      background: transparent;
      color: rgba(233,236,239,0.85);
      font-weight: 600;
      padding: 0.36rem 0.85rem;
      font-size: 0.85rem;
    }
    .trade-tab-btn.active {
      background: linear-gradient(90deg, rgba(15,176,255,0.35), rgba(74,212,255,0.35));
      color: #fff;
      box-shadow: 0 8px 20px rgba(15,176,255,0.22);
    }
    .trade-tab-btn:focus-visible, .trade-view-toggle:focus-visible {
      outline: 2px solid rgba(74,212,255,0.7);
      outline-offset: 2px;
    }
    .trade-section + .trade-section { margin-top: 0.9rem; }
    .trade-section-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }
    .trade-list {
      display: grid;
      gap: 0.7rem;
    }
    .trade-item-card {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.09);
      border-radius: 14px;
      overflow: hidden;
    }
    .trade-item-summary {
      padding: 0.8rem 0.9rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.8rem;
    }
    .trade-item-main {
      min-width: 0;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .trade-thumb {
      width: 48px;
      height: 48px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.14);
      object-fit: cover;
      background: rgba(255,255,255,0.06);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: rgba(255,255,255,0.72);
      font-weight: 700;
      flex-shrink: 0;
    }
    .trade-name {
      font-weight: 700;
      color: #f8f9fa;
      margin-bottom: 0.08rem;
      line-height: 1.15;
    }
    .trade-sub {
      font-size: 0.8rem;
      color: rgba(233,236,239,0.68);
      line-height: 1.25;
    }
    .trade-item-side {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .trade-view-toggle {
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.18);
      color: #fff;
      background: rgba(255,255,255,0.05);
      padding: 0.28rem 0.75rem;
      font-size: 0.78rem;
      font-weight: 700;
    }
    .trade-item-panel {
      border-top: 1px solid rgba(255,255,255,0.08);
      padding: 0.85rem 0.9rem 0.95rem;
      background: rgba(0,0,0,0.16);
    }
    @media (max-width: 640px) {
      .trade-item-summary {
        flex-direction: column;
        align-items: flex-start;
      }
      .trade-item-side {
        width: 100%;
        justify-content: space-between;
      }
    }
  </style>
</head>
<body class="theme-gradient d-flex flex-column min-vh-100">
  <nav class="navbar navbar-expand-sm navbar-dark bg-dark custom-navbar">
    <div class="container-fluid" role="navigation" aria-label="Main navigation">
      <a class="navbar-brand brand-logo" href="/">
        <span class="brand-main">PokeVault</span>
        <span class="brand-sub">SINGAPORE</span>
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#collapsibleNavbar" aria-controls="collapsibleNavbar" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="collapsibleNavbar">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item d-flex align-items-center me-3">
            <span class="text-light small">Signed in as <strong><%= user.username %></strong></span>
          </li>
          <li class="nav-item me-2">
            <a class="chat-link" href="/trade-chat" title="Trade chat" aria-label="Trade chat">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M4 5h16a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H9l-5 4v-4H4a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2z"/>
              </svg>
            </a>
          </li>
          <li class="nav-item me-2">
            <a class="btn btn-outline-light btn-sm btn-cta btn-minimal" href="/trades">Trade</a>
          </li>
          <li class="nav-item me-2">
            <a class="btn btn-outline-light btn-sm btn-cta btn-minimal" href="/shopping">Shop</a>
          </li>
          <li class="nav-item">
            <a class="btn btn-outline-light btn-sm btn-cta btn-minimal" href="/logout" role="button" title="Sign out">Logout</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="container page-shell flex-grow-1">
    <% const userNotificationsList = (typeof userNotifications !== 'undefined' && Array.isArray(userNotifications)) ? userNotifications : []; %>
    <% const globalNotificationsList = (typeof globalNotifications !== 'undefined' && Array.isArray(globalNotifications)) ? globalNotifications : []; %>
    <% const openTradesList = (typeof openTrades !== 'undefined' && Array.isArray(openTrades)) ? openTrades : []; %>
    <% const myTradesList = (typeof myTrades !== 'undefined' && Array.isArray(myTrades)) ? myTrades : []; %>
    <% const productsList = (typeof products !== 'undefined' && Array.isArray(products)) ? products : []; %>
    <% const messagesByTrade = (typeof messagesByTradeId !== 'undefined' && messagesByTradeId) ? messagesByTradeId : {}; %>
    <% const proposalsByTrade = (typeof proposalsByTradeId !== 'undefined' && proposalsByTradeId) ? proposalsByTradeId : {}; %>

    <div class="notification-grid mb-4">
      <div class="notification-card">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            <div class="text-uppercase text-white-50 small fw-semibold">Your notifications</div>
            <h6 class="mb-0">Inbox</h6>
          </div>
          <span class="badge text-bg-secondary"><%= userNotificationsList.length %></span>
        </div>
        <div id="user-notifications">
          <% if (!userNotificationsList.length) { %>
            <div class="notification-item text-white-50">No notifications yet.</div>
          <% } else { %>
            <% userNotificationsList.forEach(n => { %>
              <div class="notification-item">
                <div class="fw-semibold"><%= n.message %></div>
                <div class="notification-meta"><%= new Date(n.created_at).toLocaleString('en-SG', { timeZone: 'Asia/Singapore' }) %></div>
              </div>
            <% }); %>
          <% } %>
        </div>
      </div>
      <div class="notification-card">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            <div class="text-uppercase text-white-50 small fw-semibold">Global feed</div>
            <h6 class="mb-0">Collector updates</h6>
          </div>
          <span class="badge text-bg-secondary"><%= globalNotificationsList.length %></span>
        </div>
        <div id="global-notifications">
          <% if (!globalNotificationsList.length) { %>
            <div class="notification-item text-white-50">No global updates yet.</div>
          <% } else { %>
            <% globalNotificationsList.forEach(n => { %>
              <div class="notification-item">
                <div class="fw-semibold"><%= n.message %></div>
                <div class="notification-meta"><%= new Date(n.created_at).toLocaleString('en-SG', { timeZone: 'Asia/Singapore' }) %></div>
              </div>
            <% }); %>
          <% } %>
        </div>
      </div>
    </div>

    <div class="glass-card p-4">
      <% const activeTrades = myTradesList.filter(t => t.status === 'open' || t.status === 'pending_initiator'); %>
      <% const historyTrades = myTradesList.filter(t => t.status === 'accepted' || t.status === 'declined' || t.status === 'cancelled'); %>
      <div class="trade-shell">
        <div class="trade-shell-head">
          <div>
            <div class="text-uppercase text-white-50 small fw-semibold">Trade workspace</div>
            <h5 class="mb-1">Your Trades</h5>
            <div class="text-white-50 small">Use Active for pending actions. History keeps completed outcomes in one place.</div>
          </div>
          <a class="btn btn-ghost btn-sm" href="/trade-chat">Open Trade Chat</a>
        </div>

        <div class="trade-tabs" role="tablist" aria-label="Trade tabs">
          <button type="button" class="trade-tab-btn active" role="tab" aria-selected="true" aria-controls="trades-panel-active" id="trades-tab-active" data-tab-target="active">Active</button>
          <button type="button" class="trade-tab-btn" role="tab" aria-selected="false" aria-controls="trades-panel-history" id="trades-tab-history" data-tab-target="history">History</button>
        </div>

        <section id="trades-panel-active" class="trade-panel" role="tabpanel" aria-labelledby="trades-tab-active" data-tab-panel="active">
          <div class="trade-section">
            <div class="trade-section-title">
              <h6 class="mb-0">Open trades from others</h6>
              <span class="badge text-bg-secondary"><%= openTradesList.length %></span>
            </div>
            <% if (!openTradesList.length) { %>
              <p class="text-white-50 mb-0">No open trades right now.</p>
            <% } else { %>
              <div class="trade-list trade-sort-list">
                <% openTradesList.forEach(t => { %>
                  <% const cardName = t.initiator_card_name || t.initiatorProductName || ('Card #' + t.initiator_product_id); %>
                  <% const panelId = `trade-panel-open-${t.id}`; %>
                  <% const thumbSrc = t.initiator_card_image ? `/uploads/${t.initiator_card_image}` : ''; %>
                  <article class="trade-item-card" data-needs-action="1" data-last-updated="<%= new Date(t.updated_at || t.created_at).getTime() || 0 %>">
                    <div class="trade-item-summary">
                      <div class="trade-item-main">
                        <% if (thumbSrc) { %>
                          <img class="trade-thumb" src="<%= thumbSrc %>" alt="<%= cardName %> thumbnail">
                        <% } else { %>
                          <div class="trade-thumb" aria-hidden="true">TCG</div>
                        <% } %>
                        <div>
                          <div class="trade-name"><%= cardName %></div>
                          <div class="trade-sub">Counterparty: <%= t.initiatorUsername || ('User #' + t.initiator_id) %></div>
                          <div class="trade-sub">Last updated: <%= new Date(t.updated_at || t.created_at).toLocaleString('en-SG', { timeZone: 'Asia/Singapore' }) %></div>
                        </div>
                      </div>
                      <div class="trade-item-side">
                        <span class="pill pill-<%= t.status %>"><%= t.status.replace(/_/g, ' ') %></span>
                        <button type="button" class="trade-view-toggle" aria-expanded="false" aria-controls="<%= panelId %>">View</button>
                      </div>
                    </div>
                    <div class="trade-item-panel" id="<%= panelId %>" hidden>
                      <div class="trade-sub mb-2">Offer a card to start this trade.</div>
                      <form action="/trades/<%= t.id %>/offer" method="POST" class="row g-2 align-items-end">
                        <div class="col-12 col-md-6">
                          <label class="form-label text-white-50">Offer your card</label>
                          <select class="form-select form-select-sm" name="productId" required>
                            <option value="">Select</option>
                            <% productsList.forEach(p => { %>
                              <option value="<%= p.id %>"><%= p.productName %></option>
                            <% }); %>
                          </select>
                        </div>
                        <div class="col-12 col-md-4">
                          <label class="form-label text-white-50">Note (optional)</label>
                          <input class="form-control form-control-sm" name="note" maxlength="255" placeholder="Message">
                        </div>
                        <div class="col-12 col-md-2 d-grid">
                          <button type="submit" class="btn btn-ghost btn-sm">Offer</button>
                        </div>
                      </form>
                    </div>
                  </article>
                <% }); %>
              </div>
            <% } %>
          </div>

          <div class="trade-section">
            <div class="trade-section-title">
              <h6 class="mb-0">Your active trades</h6>
              <span class="badge text-bg-secondary"><%= activeTrades.length %></span>
            </div>
            <% if (!activeTrades.length) { %>
              <p class="text-white-50 mb-0">You have no active trades.</p>
            <% } else { %>
              <div class="trade-list trade-sort-list">
                <% activeTrades.forEach(t => { %>
                  <% const isOwner = t.initiator_id === user.id; %>
                  <% const isResponder = t.responder_id === user.id; %>
                  <% const ownerCard = t.initiator_card_name || t.initiatorProductName || ('Card #' + t.initiator_product_id); %>
                  <% const responderCard = t.responder_card_name || (t.responder_product_id ? (t.responderProductName || ('Card #' + t.responder_product_id)) : null); %>
                  <% const ownerLabel = isOwner ? 'You' : (t.initiatorUsername || ('User #' + t.initiator_id)); %>
                  <% const responderLabel = isResponder ? 'You' : (t.responderUsername || (t.responder_id ? ('User #' + t.responder_id) : '')); %>
                  <% const counterpartyLabel = isOwner ? (responderLabel || 'Waiting for offer') : ownerLabel; %>
                  <% const needsAction = (t.status === 'pending_initiator' && t.responder_id && isOwner) ? 1 : 0; %>
                  <% const panelId = `trade-panel-active-${t.id}`; %>
                  <% const thumbSrc = t.initiator_card_image ? `/uploads/${t.initiator_card_image}` : ''; %>
                  <article class="trade-item-card" data-needs-action="<%= needsAction %>" data-last-updated="<%= new Date(t.updated_at || t.created_at).getTime() || 0 %>">
                    <div class="trade-item-summary">
                      <div class="trade-item-main">
                        <% if (thumbSrc) { %>
                          <img class="trade-thumb" src="<%= thumbSrc %>" alt="<%= ownerCard %> thumbnail">
                        <% } else { %>
                          <div class="trade-thumb" aria-hidden="true">TCG</div>
                        <% } %>
                        <div>
                          <div class="trade-name"><%= ownerCard %></div>
                          <div class="trade-sub">Counterparty: <%= counterpartyLabel %></div>
                          <div class="trade-sub">Last updated: <%= new Date(t.updated_at || t.created_at).toLocaleString('en-SG', { timeZone: 'Asia/Singapore' }) %></div>
                        </div>
                      </div>
                      <div class="trade-item-side">
                        <span class="pill pill-<%= t.status %>"><%= t.status.replace(/_/g, ' ') %></span>
                        <button type="button" class="trade-view-toggle" aria-expanded="false" aria-controls="<%= panelId %>">View</button>
                      </div>
                    </div>
                    <div class="trade-item-panel" id="<%= panelId %>" hidden>
                      <% if (isOwner) { %>
                        <div class="trade-sub mb-2">You offered: <%= ownerCard %></div>
                        <% if (responderCard) { %>
                          <div class="trade-sub mb-2"><%= responderLabel || 'They' %> offered: <%= responderCard %></div>
                        <% } else { %>
                          <div class="trade-sub mb-2">Awaiting an offer.</div>
                        <% } %>
                      <% } else { %>
                        <div class="trade-sub mb-2"><%= ownerLabel %> offered: <%= ownerCard %></div>
                        <% if (responderCard) { %>
                          <div class="trade-sub mb-2"><%= responderLabel %> offered: <%= responderCard %></div>
                        <% } else { %>
                          <div class="trade-sub mb-2">You offered this card.</div>
                        <% } %>
                      <% } %>

                      <% if (t.status === 'pending_initiator' && t.responder_id && isOwner) { %>
                        <div class="d-flex gap-2 mb-2">
                          <form action="/trades/<%= t.id %>/accept" method="POST">
                            <button type="submit" class="btn btn-success btn-sm">Accept</button>
                          </form>
                          <form action="/trades/<%= t.id %>/decline" method="POST">
                            <button type="submit" class="btn btn-outline-danger btn-sm">Decline</button>
                          </form>
                        </div>
                      <% } %>
                      <% if (isOwner && (t.status === 'open' || t.status === 'pending_initiator')) { %>
                        <form action="/trades/<%= t.id %>/cancel" method="POST">
                          <button type="submit" class="btn btn-outline-light btn-sm">Cancel trade</button>
                        </form>
                      <% } %>
                    </div>
                  </article>
                <% }); %>
              </div>
            <% } %>
          </div>
        </section>

        <section id="trades-panel-history" class="trade-panel" role="tabpanel" aria-labelledby="trades-tab-history" data-tab-panel="history" hidden>
          <div class="trade-section">
            <div class="trade-section-title">
              <h6 class="mb-0">Trade history</h6>
              <span class="badge text-bg-secondary"><%= historyTrades.length %></span>
            </div>
            <% if (!historyTrades.length) { %>
              <p class="text-white-50 mb-0">No trade history yet.</p>
            <% } else { %>
              <div class="trade-list trade-sort-list">
                <% historyTrades.forEach(t => { %>
                  <% const isOwner = t.initiator_id === user.id; %>
                  <% const isResponder = t.responder_id === user.id; %>
                  <% const ownerCard = t.initiator_card_name || t.initiatorProductName || ('Card #' + t.initiator_product_id); %>
                  <% const responderCard = t.responder_card_name || (t.responder_product_id ? (t.responderProductName || ('Card #' + t.responder_product_id)) : null); %>
                  <% const ownerLabel = isOwner ? 'You' : (t.initiatorUsername || ('User #' + t.initiator_id)); %>
                  <% const responderLabel = isResponder ? 'You' : (t.responderUsername || (t.responder_id ? ('User #' + t.responder_id) : '')); %>
                  <% const counterpartyLabel = isOwner ? (responderLabel || 'Unknown') : ownerLabel; %>
                  <% const panelId = `trade-panel-history-${t.id}`; %>
                  <% const thumbSrc = t.initiator_card_image ? `/uploads/${t.initiator_card_image}` : ''; %>
                  <article class="trade-item-card" data-needs-action="0" data-last-updated="<%= new Date(t.updated_at || t.created_at).getTime() || 0 %>">
                    <div class="trade-item-summary">
                      <div class="trade-item-main">
                        <% if (thumbSrc) { %>
                          <img class="trade-thumb" src="<%= thumbSrc %>" alt="<%= ownerCard %> thumbnail">
                        <% } else { %>
                          <div class="trade-thumb" aria-hidden="true">TCG</div>
                        <% } %>
                        <div>
                          <div class="trade-name"><%= ownerCard %></div>
                          <div class="trade-sub">Counterparty: <%= counterpartyLabel %></div>
                          <div class="trade-sub">Last updated: <%= new Date(t.updated_at || t.created_at).toLocaleString('en-SG', { timeZone: 'Asia/Singapore' }) %></div>
                        </div>
                      </div>
                      <div class="trade-item-side">
                        <span class="pill pill-<%= t.status %>"><%= t.status.replace(/_/g, ' ') %></span>
                        <button type="button" class="trade-view-toggle" aria-expanded="false" aria-controls="<%= panelId %>">View</button>
                      </div>
                    </div>
                    <div class="trade-item-panel" id="<%= panelId %>" hidden>
                      <div class="trade-sub mb-2"><%= ownerLabel %> offered: <%= ownerCard %></div>
                      <% if (responderCard) { %>
                        <div class="trade-sub mb-2"><%= responderLabel %> offered: <%= responderCard %></div>
                      <% } %>
                      <% if (t.status === 'accepted') { %>
                        <a class="btn btn-ghost btn-sm" href="/trade-chat">Open chat</a>
                      <% } %>
                    </div>
                  </article>
                <% }); %>
              </div>
            <% } %>
          </div>
        </section>
      </div>
    </div>
  </main>

  <footer class="site-footer mt-auto">
    <div class="container text-center">
      <p class="mb-1">Connecting Pokemon card collectors worldwide - shop, sell, and trade in a safe and growing community.</p>
      <small class="small">Ac <%= new Date().getFullYear() %> PokeVault. All rights reserved.</small>
    </div>
  </footer>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    (function() {
      const user = <%- JSON.stringify(user ? { id: user.id, username: user.username } : null) %>;
      if (!user) return;
      const tradeIds = <%- JSON.stringify((myTradesList || []).filter(t => t.status === 'accepted').map(t => t.id)) %>;
      const socket = io();
      socket.emit('join', { userId: user.id, tradeIds });

      const userList = document.getElementById('user-notifications');
      const globalList = document.getElementById('global-notifications');
      const formatTime = (value) => new Date(value).toLocaleString('en-SG', { timeZone: 'Asia/Singapore' });
      const tabButtons = Array.from(document.querySelectorAll('.trade-tab-btn'));
      const tabPanels = Array.from(document.querySelectorAll('[data-tab-panel]'));

      function activateTab(key) {
        tabButtons.forEach((btn) => {
          const isActive = btn.dataset.tabTarget === key;
          btn.classList.toggle('active', isActive);
          btn.setAttribute('aria-selected', String(isActive));
          btn.setAttribute('tabindex', isActive ? '0' : '-1');
        });
        tabPanels.forEach((panel) => {
          panel.hidden = panel.dataset.tabPanel !== key;
        });
      }

      tabButtons.forEach((btn) => {
        btn.addEventListener('click', () => activateTab(btn.dataset.tabTarget));
        btn.addEventListener('keydown', (evt) => {
          if (evt.key !== 'ArrowRight' && evt.key !== 'ArrowLeft') return;
          evt.preventDefault();
          const current = tabButtons.indexOf(btn);
          const next = evt.key === 'ArrowRight'
            ? (current + 1) % tabButtons.length
            : (current - 1 + tabButtons.length) % tabButtons.length;
          tabButtons[next].focus();
          activateTab(tabButtons[next].dataset.tabTarget);
        });
      });
      activateTab('active');

      document.querySelectorAll('.trade-sort-list').forEach((list) => {
        const cards = Array.from(list.querySelectorAll('.trade-item-card'));
        cards.sort((a, b) => {
          const aAction = Number(a.dataset.needsAction || 0);
          const bAction = Number(b.dataset.needsAction || 0);
          if (bAction !== aAction) return bAction - aAction;
          const aTime = Number(a.dataset.lastUpdated || 0);
          const bTime = Number(b.dataset.lastUpdated || 0);
          return bTime - aTime;
        });
        cards.forEach((card) => list.appendChild(card));
      });

      document.addEventListener('click', (evt) => {
        const toggle = evt.target.closest('.trade-view-toggle');
        if (!toggle) return;
        const panelId = toggle.getAttribute('aria-controls');
        if (!panelId) return;
        const panel = document.getElementById(panelId);
        if (!panel) return;
        const shouldExpand = panel.hidden;
        panel.hidden = !shouldExpand;
        toggle.setAttribute('aria-expanded', String(shouldExpand));
        toggle.textContent = shouldExpand ? 'Hide' : 'View';
      });

      function prependNotification(container, message, time) {
        if (!container) return;
        const item = document.createElement('div');
        item.className = 'notification-item';
        item.innerHTML = `<div class="fw-semibold">${message}</div><div class="notification-meta">${formatTime(time)}</div>`;
        container.prepend(item);
      }

      socket.on('notification:user', (n) => prependNotification(userList, n.message, n.created_at || new Date().toISOString()));
      socket.on('notification:global', (n) => prependNotification(globalList, n.message, n.created_at || new Date().toISOString()));

      socket.on('trade:message', (msg) => {
        const container = document.getElementById(`chat-messages-${msg.trade_id}`);
        if (!container) return;
        const wrap = document.createElement('div');
        wrap.className = `chat-message ${msg.sender_id === user.id ? 'chat-out' : 'chat-in'}`;
        wrap.innerHTML = `<div class="chat-meta">${msg.senderUsername || 'User'} · ${formatTime(msg.created_at || new Date().toISOString())}</div><div class="chat-bubble"></div>`;
        wrap.querySelector('.chat-bubble').textContent = msg.message;
        container.appendChild(wrap);
        container.scrollTop = container.scrollHeight;
      });

      socket.on('meeting:proposed', (proposal) => {
        const list = document.getElementById(`proposal-list-${proposal.trade_id}`);
        if (!list) return;
        const card = document.createElement('div');
        card.className = 'proposal-card';
        card.dataset.proposalId = proposal.id;
        const actions = proposal.proposer_id !== user.id
          ? `<div class="proposal-actions">
              <button type="button" class="btn btn-success btn-sm proposal-action" data-action="accepted" data-trade-id="${proposal.trade_id}" data-proposal-id="${proposal.id}">Accept</button>
              <button type="button" class="btn btn-outline-danger btn-sm proposal-action" data-action="declined" data-trade-id="${proposal.trade_id}" data-proposal-id="${proposal.id}">Decline</button>
            </div>`
          : '';
        card.innerHTML = `
          <div>
            <div class="fw-semibold">${formatTime(proposal.proposed_at)}</div>
            <div class="notification-meta">Proposed by ${proposal.proposerUsername || 'User'} · proposed</div>
          </div>
          ${actions}
        `;
        list.appendChild(card);
      });

      socket.on('meeting:responded', (payload) => {
        const list = document.getElementById(`proposal-list-${payload.trade_id}`);
        if (!list) return;
        const card = list.querySelector(`[data-proposal-id="${payload.id}"]`);
        if (!card) return;
        const meta = card.querySelector('.notification-meta');
        if (meta) meta.textContent = `Updated · ${payload.status}`;
        const actions = card.querySelector('.proposal-actions');
        if (actions) actions.remove();
      });

      document.querySelectorAll('.chat-form').forEach((form) => {
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const tradeId = form.dataset.tradeId;
          const input = form.querySelector('input[name="message"]');
          const message = input ? input.value.trim() : '';
          if (!message) return;
          const body = new URLSearchParams({ message });
          try {
            const res = await fetch(`/trades/${tradeId}/messages`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
              body
            });
            if (!res.ok) throw new Error('Message failed');
            if (input) input.value = '';
          } catch (err) {
            console.error(err);
          }
        });
      });

      document.querySelectorAll('.proposal-form').forEach((form) => {
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const tradeId = form.dataset.tradeId;
          const input = form.querySelector('input[name="proposedAt"]');
          const proposedAt = input ? input.value : '';
          if (!proposedAt) return;
          const body = new URLSearchParams({ proposedAt });
          try {
            const res = await fetch(`/trades/${tradeId}/meeting-proposals`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
              body
            });
            if (!res.ok) throw new Error('Proposal failed');
            if (input) input.value = '';
          } catch (err) {
            console.error(err);
          }
        });
      });

      document.addEventListener('click', async (e) => {
        const btn = e.target.closest('.proposal-action');
        if (!btn) return;
        const tradeId = btn.dataset.tradeId;
        const proposalId = btn.dataset.proposalId;
        const action = btn.dataset.action;
        const body = new URLSearchParams({ action });
        try {
          const res = await fetch(`/trades/${tradeId}/meeting-proposals/${proposalId}/respond`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body
          });
          if (!res.ok) throw new Error('Response failed');
        } catch (err) {
          console.error(err);
        }
      });
    })();
  </script>
</body>
</html>
